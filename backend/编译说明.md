# 21点游戏服务器 - 编译说明

## 前置要求

在编译之前，需要确保：

1. **安装Go语言环境**
   - 下载地址：https://go.dev/dl/
   - 推荐版本：1.21 或更高
   - 安装后将Go添加到系统PATH

2. **验证Go安装**
   ```bash
   go version
   ```
   应该显示类似：`go version go1.21.x windows/amd64`

## 编译步骤

### 方法1：使用Go命令直接编译

#### 编译Linux AMD64版本
```bash
cd d:\code\puke21dian\backend
set GOOS=linux
set GOARCH=amd64
go build -o build/blackjack-linux-amd64 .
```

#### 编译Linux ARM64版本
```bash
set GOOS=linux
set GOARCH=arm64
go build -o build/blackjack-linux-arm64 .
```

#### 编译Windows版本（本地测试）
```bash
set GOOS=windows
set GOARCH=amd64
go build -o build/blackjack-windows-amd64.exe .
```

### 方法2：使用批处理脚本（Windows）

如果已安装Go，直接运行：
```bash
cd d:\code\puke21dian\backend
build.bat
```

### 方法3：使用Shell脚本（Linux/Mac）

```bash
cd backend
chmod +x build.sh
./build.sh
```

## 输出文件

编译成功后，在 `build/` 目录下会生成：

- `blackjack-linux-amd64` - Linux x64服务器可执行文件
- `blackjack-linux-arm64` - Linux ARM64可执行文件（树莓派等）
- `blackjack-windows-amd64.exe` - Windows可执行文件（本地测试）
- `start.sh` - Linux启动脚本
- `blackjack.service` - systemd服务配置
- `README.txt` - 部署说明

## 常见问题

### 1. 提示 "go 不是内部或外部命令"

**原因**：Go未安装或未添加到PATH

**解决方案**：
1. 安装Go：https://go.dev/dl/
2. 将Go安装目录添加到系统PATH
   - 默认位置：`C:\Program Files\Go\bin`
3. 重启命令行窗口

### 2. 提示 "cannot find package"

**原因**：依赖未下载

**解决方案**：
```bash
cd d:\code\puke21dian\backend
go mod tidy
```

### 3. 编译速度慢

**原因**：首次编译需要下载依赖

**解决方案**：
- 使用国内镜像加速：
  ```bash
  go env -w GOPROXY=https://goproxy.cn,direct
  ```

## 快速部署到Linux服务器

### 步骤1：编译Linux版本
```bash
cd d:\code\puke21dian\backend
set GOOS=linux
set GOARCH=amd64
go build -o build/blackjack-linux-amd64 .
```

### 步骤2：上传到服务器
```bash
scp build/blackjack-linux-amd64 user@your-server:/opt/blackjack/
scp -r ../ user@your-server:/opt/blackjack/public/
```

### 步骤3：在服务器上运行
```bash
ssh user@your-server
cd /opt/blackjack
chmod +x blackjack-linux-amd64
./blackjack-linux-amd64
```

### 步骤4：配置防火墙（如果需要）
```bash
sudo ufw allow 8080/tcp
```

### 步骤5：访问游戏
```
http://your-server:8080/21dian.html
```

## 测试本地开发环境

如果你想快速测试开发环境，编译Windows版本：

```bash
set GOOS=windows
set GOARCH=amd64
go build -o build/test-server.exe .
cd build
test-server.exe
```

然后在浏览器打开：`http://localhost:8080/21dian.html`

## 性能优化建议

### 1. 编译优化参数
```bash
go build -ldflags="-s -w" -o build/blackjack-linux-amd64 .
```
`-s -w` 会移除调试信息，减小可执行文件大小

### 2. 使用UPX压缩（可选）
```bash
upx --best build/blackjack-linux-amd64
```

### 3. 生产环境部署
- 使用systemd管理服务
- 配置Nginx反向代理
- 启用HTTPS/WSS
- 配置日志轮转

## 项目文件说明

### 后端核心文件
- `main.go` - 主程序入口，HTTP服务器
- `card.go` - 扑克牌逻辑
- `player.go` - 玩家管理
- `room.go` - 房间管理
- `websocket.go` - WebSocket通信

### 前端文件
- `21dian.html` - 首页（创建/加入房间）
- `21game.html` - 游戏页面
- `21game.js` - 游戏客户端（WebSocket通信）
- `common.css` - 通用样式
- `puke_sprites.css` - 扑克精灵图

### 配置文件
- `go.mod` - Go依赖管理
- `build.sh` - Linux/Mac构建脚本
- `build.bat` - Windows构建脚本

## 后续开发

如果需要继续开发：

1. 运行开发服务器：
   ```bash
   go run .
   ```

2. 修改代码后自动重启：
   ```bash
   # 使用air工具（需先安装）
   go install github.com/cosmtrek/air@latest
   air
   ```

3. 监控日志：
   服务器会在控制台输出详细的运行日志，包括：
   - 玩家连接/断开
   - 房间创建/销毁
   - 游戏状态变化
   - 错误信息

## 技术支持

如有问题，请检查：
1. Go版本是否正确（>= 1.21）
2. 网络连接（下载依赖）
3. 文件权限（Linux环境）
4. 防火墙设置

祝编译顺利！🎰
